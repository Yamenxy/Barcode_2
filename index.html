<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      direction: ltr;
    }
    #reader {
      width: 300px;
      margin: auto;
    }
    select, button, input {
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
    }
    table, th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f2f2f2;
    }
  </style>
  <style>
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 10px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

</head>
<body>

  <h2>ุฃููู ุซุงููู</h2>
  <h2>Attendance</h2>
  
  <div id="reader"></div>

  <select id="attendanceType">
    <option value="ุงูุญุถูุฑ ุงูุงูู">ุงูุญุถูุฑ ุงูุฃูู</option>
    <option value="ุงูุญุถูุฑ ุงูุซุงูู">ุงูุญุถูุฑ ุงูุซุงูู</option>
    <option value="ุงูุญุถูุฑ ุงูุซุงูุซ">ุงูุญุถูุฑ ุงูุซุงูุซ</option>
    <option value="ุงูุญุถูุฑ ุงูุฑุงุจุน">ุงูุญุถูุฑ ุงูุฑุงุจุน</option>
    <option value="ุงูุญุถูุฑ ุงูุฎุงูุณ">ุงูุญุถูุฑ ุงูุฎุงูุณ</option>
    <option value="ุงูุญุถูุฑ ุงูุณุงุฏุณ">ุงูุญุถูุฑ ุงูุณุงุฏุณ</option>
    <option value="ุงูุญุถูุฑ ุงูุณุงุจุน">ุงูุญุถูุฑ ุงูุณุงุจุน</option>
    <option value="ุงูุญุถูุฑ ุงูุซุงูู">ุงูุญุถูุฑ ุงูุซุงูู</option>
    <option value="ุงูุญุถูุฑ ุงูุดุงูู">ุงูุญุถูุฑ ุงูุดุงูู</option>
    <option value="ุงูุญุถูุฑ ุงูุชุงุณุน">ุงูุญุถูุฑ ุงูุชุงุณุน</option>
    <option value="ุงูุญุถูุฑ ุงูุนุงุดุฑ">ุงูุญุถูุฑ ุงูุนุงุดุฑ</option>
    <option value="ุงูุญุถูุฑ ุงูุญุงุฏู ุนุดุฑ">ุงูุญุถูุฑ ุงูุญุงุฏู ุนุดุฑ</option>
    <option value="ุงูุญุถูุฑ ุงูุซุงูู ุนุดุฑ">ุงูุญุถูุฑ ุงูุซุงูู ุนุดุฑ</option>
    <option value="ุงูุญุถูุฑ ุงูุซุงูุซ ุนุดุฑ">ุงูุญุถูุฑ ุงูุซุงูุซ ุนุดุฑ</option>
    <option value="ุงูุญุถูุฑ ุงูุฑุงุจุน ุนุดุฑ">ุงูุญุถูุฑ ุงูุฑุงุจุน ุนุดุฑ</option>    
    <option value="ุงูุญุถูุฑ ุงูุฎุงูุณ ุนุดุฑ">ุงูุญุถูุฑ ุงูุฎุงูุณ ุนุดุฑ</option>    
    <option value="ุงูุญุถูุฑ ุงูุณุงุฏุณ ุนุดุฑ">ุงูุญุถูุฑ ุงูุณุงุฏุณ ุนุดุฑ</option>    
    <option value="ุงูุญุถูุฑ ุงูุณุงุจุน ุนุดุฑ">ุงูุญุถูุฑ ุงูุณุงุจุน ุนุดุฑ</option>    
    <option value="ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุงููู">ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุงููู</option>    
    <option value="ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงููุฉ">ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงููุฉ</option>    
    <option value="ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงูุซุฉ">ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงูุซุฉ</option>    
  </select>

  <br>

  <input 
    type="text" 
    id="manualBarcode" 
    placeholder="Or enter the code here" 
    autofocus 
    oninput="checkBarcode(this)">

  <br>

  <button onclick="startScanner()">Start Scanning</button>
  <button onclick="submitManually()">Attend with Code</button>

  <p id="status"></p>

  <!-- Table to display attendance -->
  <p id="studentName"></p>
  <div id="attendanceTable"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxuTddjxhk0OzVubze1RQA2TjA3GpG43PhgdIOyNVwbfUN68RbDHu6h2xsT-3dwa3YWEw/exec"; 
    let scanner, lastScanned = "", lastTime = 0;

    function checkBarcode(input) {
      input.value = input.value.replace(/\D/g, '');
      if (input.value.length === 5) {
        submitManually();
        input.value = ""; 
      }
    }

    function startScanner() {
      scanner = new Html5QrcodeScanner("reader", { fps: 30, qrbox: 250 });
      scanner.render(onScanSuccess, (errorMessage) => {
        console.warn(errorMessage);
      });
    }

    function onScanSuccess(decodedText) {
      const now = Date.now();
      if (decodedText === lastScanned && (now - lastTime < 1000)) {
        return;
      }
      lastScanned = decodedText;
      lastTime = now; 
      document.getElementById("status").innerText = "Verifying...";
      const attendanceType = document.getElementById("attendanceType").value;
      submitData(decodedText, attendanceType);
    }

    function submitManually() {
      const barcode = document.getElementById("manualBarcode").value;
      const attendanceType = document.getElementById("attendanceType").value;
      if (!barcode) {
        document.getElementById("status").innerText = "Please enter the barcode!";
        return;
      }
      document.getElementById("status").innerText = "Verifying...";
      submitData(barcode, attendanceType);
    }

    function showLoading() {
      document.getElementById("status").innerHTML = 'ุฌุงุฑู ุงูุชุญูู... <span class="spinner"></span>';
    }

    function hideLoading(message) {
      document.getElementById("status").innerText = message;
    }

    function submitData(barcode, attendanceType) {
      // Clear old data before verifying
      document.getElementById("studentName").innerText = "";
      document.getElementById("attendanceTable").innerHTML = "";

      showLoading(); // ๐ ุนุฑุถ ุงูุณุจููุฑ

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({
          barcode: barcode,
          attendanceType: attendanceType
        })
      })
      .then(response => response.json())
      .then(data => {
           hideLoading(data.message); // ๐ ุฅุฎูุงุก ุงูุณุจููุฑ ูุนุฑุถ ุงููุชูุฌุฉ
           if (data.studentName) {
               document.getElementById("studentName").innerText = "ุงูุทุงูุจ: " + data.studentName;
           }
           if (data.attendance) {
               renderAttendanceTable(data.attendance);
           }
       })
      .catch(error => {
        console.error("Error:", error.message);
        hideLoading("Connection error occurred!");
      });
    }



    function renderAttendanceTable(attendanceArray) {
      let headers = [
        "ุงูุญุถูุฑ ุงูุฃูู","ุงูุญุถูุฑ ุงูุซุงูู","ุงูุญุถูุฑ ุงูุซุงูุซ","ุงูุญุถูุฑ ุงูุฑุงุจุน",
        "ุงูุญุถูุฑ ุงูุฎุงูุณ","ุงูุญุถูุฑ ุงูุณุงุฏุณ","ุงูุญุถูุฑ ุงูุณุงุจุน","ุงูุญุถูุฑ ุงูุซุงูู",
        "ุงูุญุถูุฑ ุงูุดุงูู","ุงูุญุถูุฑ ุงูุชุงุณุน","ุงูุญุถูุฑ ุงูุนุงุดุฑ","ุงูุญุถูุฑ ุงูุญุงุฏู ุนุดุฑ",
        "ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุฃููู","ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงููุฉ","ุญุถูุฑ ุงููุฑุงุฌุนุฉ ุงูุซุงูุซุฉ","ุญุถูุฑ ุงููุฑุงุฌุนุฉ ูููุฉ ุงูุงูุชุญุงู"
      ];
      
      let table = "<table><tr>";
      headers.forEach(h => table += `<th>${h}</th>`);
      table += "</tr><tr>";
      attendanceArray.forEach(val => {
        table += `<td>${val === "โ" ? "โ" : "โ"}</td>`;
      });
      table += "</tr></table>";
      document.getElementById("attendanceTable").innerHTML = table;
    }
  </script>

</body>
</html>
